{"ast":null,"code":"import { createElementVNode as _createElementVNode, toDisplayString as _toDisplayString, resolveComponent as _resolveComponent, createVNode as _createVNode, createTextVNode as _createTextVNode, withCtx as _withCtx, openBlock as _openBlock, createElementBlock as _createElementBlock } from \"vue\";\nimport _imports_0 from '../assets/img_10.png';\nconst _hoisted_1 = {\n  class: \"rating-wrapper\"\n};\nconst _hoisted_2 = {\n  class: \"order-info\"\n};\nconst _hoisted_3 = {\n  class: \"business-info\"\n};\nconst _hoisted_4 = [\"src\"];\nconst _hoisted_5 = {\n  class: \"business-details\"\n};\nconst _hoisted_6 = {\n  class: \"rating-form\"\n};\nconst _hoisted_7 = {\n  class: \"rating-section\"\n};\nconst _hoisted_8 = {\n  class: \"star-rating\"\n};\nconst _hoisted_9 = {\n  class: \"rating-section\"\n};\nconst _hoisted_10 = {\n  class: \"star-rating\"\n};\nconst _hoisted_11 = {\n  class: \"rating-section\"\n};\nconst _hoisted_12 = {\n  class: \"submit-section\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  const _component_el_rate = _resolveComponent(\"el-rate\");\n  const _component_el_input = _resolveComponent(\"el-input\");\n  const _component_el_button = _resolveComponent(\"el-button\");\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_createElementVNode(\"header\", {\n    class: \"rating-header\"\n  }, [_createElementVNode(\"div\", {\n    class: \"back-button\",\n    onClick: $setup.goBack\n  }, _cache[3] || (_cache[3] = [_createElementVNode(\"img\", {\n    src: _imports_0,\n    alt: \"返回\"\n  }, null, -1 /* HOISTED */)])), _cache[4] || (_cache[4] = _createElementVNode(\"h2\", null, \"订单评价\", -1 /* HOISTED */))]), _createElementVNode(\"div\", _hoisted_2, [_createElementVNode(\"div\", _hoisted_3, [_createElementVNode(\"img\", {\n    src: $setup.processImageUrl($setup.businessImg),\n    alt: \"商家图片\",\n    class: \"business-img\"\n  }, null, 8 /* PROPS */, _hoisted_4), _createElementVNode(\"div\", _hoisted_5, [_createElementVNode(\"h3\", null, _toDisplayString($setup.businessName), 1 /* TEXT */), _createElementVNode(\"p\", null, \"订单编号: \" + _toDisplayString($setup.orderId), 1 /* TEXT */), _createElementVNode(\"p\", null, \"订单时间: \" + _toDisplayString($setup.orderDate), 1 /* TEXT */)])])]), _createElementVNode(\"div\", _hoisted_6, [_createElementVNode(\"div\", _hoisted_7, [_cache[5] || (_cache[5] = _createElementVNode(\"h3\", null, \"菜品评分\", -1 /* HOISTED */)), _createElementVNode(\"div\", _hoisted_8, [_createVNode(_component_el_rate, {\n    modelValue: $setup.foodRating,\n    \"onUpdate:modelValue\": _cache[0] || (_cache[0] = $event => $setup.foodRating = $event),\n    colors: ['#99A9BF', '#F7BA2A', '#FF9900'],\n    \"show-text\": true,\n    texts: ['很差', '较差', '一般', '不错', '很好']\n  }, null, 8 /* PROPS */, [\"modelValue\"])])]), _createElementVNode(\"div\", _hoisted_9, [_cache[6] || (_cache[6] = _createElementVNode(\"h3\", null, \"配送评分\", -1 /* HOISTED */)), _createElementVNode(\"div\", _hoisted_10, [_createVNode(_component_el_rate, {\n    modelValue: $setup.deliveryRating,\n    \"onUpdate:modelValue\": _cache[1] || (_cache[1] = $event => $setup.deliveryRating = $event),\n    colors: ['#99A9BF', '#F7BA2A', '#FF9900'],\n    \"show-text\": true,\n    texts: ['很差', '较差', '一般', '不错', '很好']\n  }, null, 8 /* PROPS */, [\"modelValue\"])])]), _createElementVNode(\"div\", _hoisted_11, [_cache[7] || (_cache[7] = _createElementVNode(\"h3\", null, \"评价内容\", -1 /* HOISTED */)), _createVNode(_component_el_input, {\n    type: \"textarea\",\n    modelValue: $setup.content,\n    \"onUpdate:modelValue\": _cache[2] || (_cache[2] = $event => $setup.content = $event),\n    rows: 4,\n    placeholder: \"请输入您的评价内容，分享您的用餐体验...\"\n  }, null, 8 /* PROPS */, [\"modelValue\"])]), _createElementVNode(\"div\", _hoisted_12, [_createVNode(_component_el_button, {\n    type: \"primary\",\n    onClick: $setup.submitRating,\n    disabled: $setup.isSubmitting\n  }, {\n    default: _withCtx(() => [_createTextVNode(_toDisplayString($setup.isSubmitting ? '提交中...' : '提交评价'), 1 /* TEXT */)]),\n    _: 1 /* STABLE */\n  }, 8 /* PROPS */, [\"disabled\"])])])]);\n}","map":{"version":3,"names":["_imports_0","class","_createElementBlock","_hoisted_1","_createElementVNode","onClick","$setup","goBack","src","alt","_hoisted_2","_hoisted_3","processImageUrl","businessImg","_hoisted_4","_hoisted_5","_toDisplayString","businessName","orderId","orderDate","_hoisted_6","_hoisted_7","_hoisted_8","_createVNode","_component_el_rate","modelValue","foodRating","_cache","$event","colors","texts","_hoisted_9","_hoisted_10","deliveryRating","_hoisted_11","_component_el_input","type","content","rows","placeholder","_hoisted_12","_component_el_button","submitRating","disabled","isSubmitting","default","_withCtx","_createTextVNode","_"],"sources":["D:\\back_elm\\vue_elm\\src\\components\\RatingComponent.vue"],"sourcesContent":["<template>\n  <div class=\"rating-wrapper\">\n    <header class=\"rating-header\">\n      <div class=\"back-button\" @click=\"goBack\">\n        <img src=\"../assets/img_10.png\" alt=\"返回\">\n      </div>\n      <h2>订单评价</h2>\n    </header>\n\n    <div class=\"order-info\">\n      <div class=\"business-info\">\n        <img :src=\"processImageUrl(businessImg)\" alt=\"商家图片\" class=\"business-img\">\n        <div class=\"business-details\">\n          <h3>{{ businessName }}</h3>\n          <p>订单编号: {{ orderId }}</p>\n          <p>订单时间: {{ orderDate }}</p>\n        </div>\n      </div>\n    </div>\n\n    <div class=\"rating-form\">\n      <div class=\"rating-section\">\n        <h3>菜品评分</h3>\n        <div class=\"star-rating\">\n          <el-rate\n            v-model=\"foodRating\"\n            :colors=\"['#99A9BF', '#F7BA2A', '#FF9900']\"\n            :show-text=\"true\"\n            :texts=\"['很差', '较差', '一般', '不错', '很好']\"\n          ></el-rate>\n        </div>\n      </div>\n\n      <div class=\"rating-section\">\n        <h3>配送评分</h3>\n        <div class=\"star-rating\">\n          <el-rate\n            v-model=\"deliveryRating\"\n            :colors=\"['#99A9BF', '#F7BA2A', '#FF9900']\"\n            :show-text=\"true\"\n            :texts=\"['很差', '较差', '一般', '不错', '很好']\"\n          ></el-rate>\n        </div>\n      </div>\n\n      <div class=\"rating-section\">\n        <h3>评价内容</h3>\n        <el-input\n          type=\"textarea\"\n          v-model=\"content\"\n          :rows=\"4\"\n          placeholder=\"请输入您的评价内容，分享您的用餐体验...\"\n        ></el-input>\n      </div>\n\n      <div class=\"submit-section\">\n        <el-button type=\"primary\" @click=\"submitRating\" :disabled=\"isSubmitting\">\n          {{ isSubmitting ? '提交中...' : '提交评价' }}\n        </el-button>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script setup>\nimport { ref, onMounted } from 'vue';\nimport { useRoute, useRouter } from 'vue-router';\nimport { ratingApi } from '@/utils/api';\nimport { ElMessage } from 'element-plus';\n\nconst route = useRoute();\nconst router = useRouter();\n\n// 获取路由参数并提供默认值\nconst orderId = ref(route.params.orderId || '1');\nconst businessId = ref(route.params.businessId || '1');\nconst businessName = ref(route.params.businessName || '未知商家');\nconst businessImg = ref(route.query.businessImg || '');\nconst orderDate = ref(route.query.orderDate || new Date().toLocaleString());\n\n// 评价表单数据\nconst foodRating = ref(5); // 默认5分\nconst deliveryRating = ref(5); // 默认5分\nconst content = ref('');\nconst isSubmitting = ref(false);\n\n// 返回上一页\nconst goBack = () => {\n  router.back();\n};\n\n// 处理图片URL\nconst processImageUrl = (imgPath) => {\n  if (!imgPath) {\n    return require('../assets/img/BUSINESS/img.png');\n  }\n  \n  console.log('处理评价页面图片路径:', imgPath);\n  \n  // 如果是完整URL或base64，直接返回\n  if (imgPath.startsWith('http') || imgPath.startsWith('data:')) {\n    return imgPath;\n  }\n  \n  // 如果是以/assets开头的路径，转换为正确的路径\n  if (imgPath.startsWith('/assets/')) {\n    // 去掉开头的/assets/，因为在项目中assets是相对路径\n    const relativePath = imgPath.replace('/assets/', '');\n    try {\n      return require(`../assets/${relativePath}`);\n    } catch (e) {\n      console.log('无法加载assets路径图片，尝试其他方式:', e);\n      // 尝试通过API网关获取\n      return 'http://localhost:8090' + imgPath;\n    }\n  }\n  \n  // 如果是相对路径，添加baseURL\n  if (imgPath.startsWith('/')) {\n    return 'http://localhost:8090' + imgPath;\n  }\n  \n  // 尝试加载项目中的图片\n  try {\n    // 首先尝试从BUSINESS目录加载\n    if (!imgPath.includes('/')) {\n      try {\n        return require('../assets/img/BUSINESS/' + imgPath);\n      } catch (e) {\n        console.log('BUSINESS目录未找到图片，尝试其他路径');\n      }\n    }\n    \n    // 然后尝试从普通img目录加载\n    return require('../assets/img/' + imgPath);\n  } catch (e) {\n    console.error('无法加载评价页面图片:', imgPath, e);\n    return require('../assets/img/BUSINESS/img.png');\n  }\n};\n\n// 提交评价\nconst submitRating = async () => {\n  if (foodRating.value === 0 || deliveryRating.value === 0) {\n    ElMessage.warning('请为菜品和配送服务评分');\n    return;\n  }\n\n  if (!content.value.trim()) {\n    ElMessage.warning('请输入评价内容');\n    return;\n  }\n\n  try {\n    isSubmitting.value = true;\n    \n    // 获取用户ID\n    const userId = localStorage.getItem('userId');\n    if (!userId) {\n      ElMessage.error('请先登录');\n      router.push('/login-component');\n      return;\n    }\n\n    // 构建评价数据\n    const ratingData = {\n      orderId: Number(orderId.value),\n      userId: userId,\n      businessId: Number(businessId.value),\n      businessName: businessName.value,\n      foodRating: foodRating.value,\n      deliveryRating: deliveryRating.value,\n      content: content.value,\n      createTime: new Date().toISOString()\n    };\n\n    try {\n      // 尝试调用API提交评价\n      console.log('尝试提交评价到API:', ratingData);\n      const response = await ratingApi.submitRating(ratingData);\n      \n      if (response) {\n        // 同时保存到本地存储，作为备份\n        saveRatingToLocalStorage(ratingData);\n        \n        ElMessage.success('评价提交成功');\n        // 延迟后返回订单历史页面\n        setTimeout(() => {\n          router.push('/history-component');\n        }, 1500);\n      } else {\n        ElMessage.error('评价提交失败');\n      }\n    } catch (error) {\n      console.error('评价提交API调用出错:', error);\n      \n      // 保存到本地存储\n      saveRatingToLocalStorage(ratingData);\n      \n      // 给用户成功的反馈\n      ElMessage({\n        message: '评价已本地保存，将在服务恢复后同步',\n        type: 'success',\n        duration: 2000\n      });\n      \n      setTimeout(() => {\n        router.push('/history-component');\n      }, 2000);\n    }\n  } catch (error) {\n    console.error('评价提交出错:', error);\n    ElMessage.error('评价提交出错: ' + (error.message || '未知错误'));\n  } finally {\n    isSubmitting.value = false;\n  }\n};\n\n// 将评价保存到本地存储\nconst saveRatingToLocalStorage = (ratingData) => {\n  try {\n    // 获取现有评价\n    const ratingsString = localStorage.getItem('localRatings');\n    let ratings = [];\n    \n    if (ratingsString) {\n      ratings = JSON.parse(ratingsString);\n    }\n    \n    // 确保orderId是数字类型\n    const ratingWithNumericId = {\n      ...ratingData,\n      orderId: Number(ratingData.orderId)\n    };\n    \n    // 检查是否已经有该订单的评价\n    const existingIndex = ratings.findIndex(r => r.orderId === ratingWithNumericId.orderId);\n    \n    if (existingIndex >= 0) {\n      // 更新现有评价\n      ratings[existingIndex] = ratingWithNumericId;\n    } else {\n      // 添加新评价\n      ratings.push(ratingWithNumericId);\n    }\n    \n    // 保存回本地存储\n    localStorage.setItem('localRatings', JSON.stringify(ratings));\n    console.log('评价已保存到本地存储', ratings);\n  } catch (error) {\n    console.error('保存评价到本地存储失败:', error);\n  }\n};\n\n// 从本地存储中获取评价\nconst getLocalRating = (orderId) => {\n  try {\n    const ratingsString = localStorage.getItem('localRatings');\n    console.log(`尝试从本地获取订单 ${orderId} 的评价, 本地存储:`, ratingsString);\n    \n    if (ratingsString) {\n      const ratings = JSON.parse(ratingsString);\n      console.log('解析后的本地评价:', ratings);\n      \n      const numericOrderId = Number(orderId);\n      const rating = ratings.find(r => r.orderId === numericOrderId);\n      \n      console.log(`订单 ${orderId} 的本地评价:`, rating);\n      return rating;\n    }\n  } catch (error) {\n    console.error('从本地存储获取评价失败:', error);\n  }\n  return null;\n};\n\n// 组件加载时检查是否已经评价过\nonMounted(async () => {\n  try {\n    if (orderId.value) {\n      // 先检查本地存储\n      const localRating = getLocalRating(orderId.value);\n      \n      if (localRating) {\n        // 使用本地存储的评价数据\n        foodRating.value = localRating.foodRating || 5;\n        deliveryRating.value = localRating.deliveryRating || 5;\n        content.value = localRating.content || '';\n        ElMessage.info('找到您之前的评价，您可以修改后重新提交');\n        return;\n      }\n      \n      // 如果本地没有，尝试从API获取\n      try {\n        const response = await ratingApi.getRatingByOrderId(orderId.value);\n        console.log('API返回的评价数据:', response);\n        \n        if (response && response.data && Object.keys(response.data).length > 0) {\n          // 已有评价，填充表单\n          foodRating.value = response.data.foodRating || 5;\n          deliveryRating.value = response.data.deliveryRating || 5;\n          content.value = response.data.content || '';\n          ElMessage.info('找到您之前的评价，您可以修改后重新提交');\n        } else {\n          console.log('API返回空数据或无效数据，视为新评价');\n          // 设置默认值\n          foodRating.value = 5;\n          deliveryRating.value = 5;\n          content.value = '';\n        }\n      } catch (error) {\n        console.error('获取评价信息出错:', error);\n        // 获取失败不做特殊处理，当作新评价\n        ElMessage.info('这是您第一次评价此订单');\n      }\n    }\n  } catch (error) {\n    console.error('组件加载时出错:', error);\n  }\n});\n</script>\n\n<style scoped>\n.rating-wrapper {\n  padding: 15px;\n  max-width: 600px;\n  margin: 0 auto;\n}\n\n.rating-header {\n  display: flex;\n  align-items: center;\n  margin-bottom: 20px;\n  position: relative;\n}\n\n.back-button {\n  position: absolute;\n  left: 0;\n  display: flex;\n  align-items: center;\n  cursor: pointer;\n}\n\n.back-button img {\n  width: 24px;\n  height: 24px;\n}\n\n.rating-header h2 {\n  flex: 1;\n  text-align: center;\n  margin: 0;\n  font-size: 18px;\n}\n\n.order-info {\n  background-color: #f8f8f8;\n  border-radius: 8px;\n  padding: 15px;\n  margin-bottom: 20px;\n}\n\n.business-info {\n  display: flex;\n  align-items: center;\n}\n\n.business-img {\n  width: 60px;\n  height: 60px;\n  border-radius: 4px;\n  object-fit: cover;\n  margin-right: 15px;\n}\n\n.business-details h3 {\n  margin: 0 0 5px 0;\n  font-size: 16px;\n}\n\n.business-details p {\n  margin: 3px 0;\n  font-size: 14px;\n  color: #666;\n}\n\n.rating-section {\n  margin-bottom: 20px;\n}\n\n.rating-section h3 {\n  margin-bottom: 10px;\n  font-size: 16px;\n}\n\n.star-rating {\n  margin-bottom: 10px;\n}\n\n.submit-section {\n  margin-top: 30px;\n  text-align: center;\n}\n\n.submit-section button {\n  width: 80%;\n  max-width: 300px;\n}\n</style> "],"mappings":";OAIaA,UAA0B;;EAHhCC,KAAK,EAAC;AAAgB;;EAQpBA,KAAK,EAAC;AAAY;;EAChBA,KAAK,EAAC;AAAe;mBAVhC;;EAYaA,KAAK,EAAC;AAAkB;;EAQ5BA,KAAK,EAAC;AAAa;;EACjBA,KAAK,EAAC;AAAgB;;EAEpBA,KAAK,EAAC;AAAa;;EAUrBA,KAAK,EAAC;AAAgB;;EAEpBA,KAAK,EAAC;AAAa;;EAUrBA,KAAK,EAAC;AAAgB;;EAUtBA,KAAK,EAAC;AAAgB;;;;;uBAtD/BC,mBAAA,CA4DM,OA5DNC,UA4DM,GA3DJC,mBAAA,CAKS;IALDH,KAAK,EAAC;EAAe,IAC3BG,mBAAA,CAEM;IAFDH,KAAK,EAAC,aAAa;IAAEI,OAAK,EAAEC,MAAA,CAAAC;gCAC/BH,mBAAA,CAAyC;IAApCI,GAA0B,EAA1BR,UAA0B;IAACS,GAAG,EAAC;2DAEtCL,mBAAA,CAAa,YAAT,MAAI,qB,GAGVA,mBAAA,CASM,OATNM,UASM,GARJN,mBAAA,CAOM,OAPNO,UAOM,GANJP,mBAAA,CAAyE;IAAnEI,GAAG,EAAEF,MAAA,CAAAM,eAAe,CAACN,MAAA,CAAAO,WAAW;IAAGJ,GAAG,EAAC,MAAM;IAACR,KAAK,EAAC;0BAXlEa,UAAA,GAYQV,mBAAA,CAIM,OAJNW,UAIM,GAHJX,mBAAA,CAA2B,YAAAY,gBAAA,CAApBV,MAAA,CAAAW,YAAY,kBACnBb,mBAAA,CAA0B,WAAvB,QAAM,GAAAY,gBAAA,CAAGV,MAAA,CAAAY,OAAO,kBACnBd,mBAAA,CAA4B,WAAzB,QAAM,GAAAY,gBAAA,CAAGV,MAAA,CAAAa,SAAS,iB,OAK3Bf,mBAAA,CAwCM,OAxCNgB,UAwCM,GAvCJhB,mBAAA,CAUM,OAVNiB,UAUM,G,0BATJjB,mBAAA,CAAa,YAAT,MAAI,sBACRA,mBAAA,CAOM,OAPNkB,UAOM,GANJC,YAAA,CAKWC,kBAAA;IA7BrBC,UAAA,EAyBqBnB,MAAA,CAAAoB,UAAU;IAzB/B,uBAAAC,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAyBqBtB,MAAA,CAAAoB,UAAU,GAAAE,MAAA;IAClBC,MAAM,EAAE,iCAAiC;IACzC,WAAS,EAAE,IAAI;IACfC,KAAK,EAAE;+CAKd1B,mBAAA,CAUM,OAVN2B,UAUM,G,0BATJ3B,mBAAA,CAAa,YAAT,MAAI,sBACRA,mBAAA,CAOM,OAPN4B,WAOM,GANJT,YAAA,CAKWC,kBAAA;IAzCrBC,UAAA,EAqCqBnB,MAAA,CAAA2B,cAAc;IArCnC,uBAAAN,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAqCqBtB,MAAA,CAAA2B,cAAc,GAAAL,MAAA;IACtBC,MAAM,EAAE,iCAAiC;IACzC,WAAS,EAAE,IAAI;IACfC,KAAK,EAAE;+CAKd1B,mBAAA,CAQM,OARN8B,WAQM,G,0BAPJ9B,mBAAA,CAAa,YAAT,MAAI,sBACRmB,YAAA,CAKYY,mBAAA;IAJVC,IAAI,EAAC,UAAU;IAhDzBX,UAAA,EAiDmBnB,MAAA,CAAA+B,OAAO;IAjD1B,uBAAAV,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAiDmBtB,MAAA,CAAA+B,OAAO,GAAAT,MAAA;IACfU,IAAI,EAAE,CAAC;IACRC,WAAW,EAAC;6CAIhBnC,mBAAA,CAIM,OAJNoC,WAIM,GAHJjB,YAAA,CAEYkB,oBAAA;IAFDL,IAAI,EAAC,SAAS;IAAE/B,OAAK,EAAEC,MAAA,CAAAoC,YAAY;IAAGC,QAAQ,EAAErC,MAAA,CAAAsC;;IAxDnEC,OAAA,EAAAC,QAAA,CAyDU,MAAsC,CAzDhDC,gBAAA,CAAA/B,gBAAA,CAyDaV,MAAA,CAAAsC,YAAY,qC;IAzDzBI,CAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}