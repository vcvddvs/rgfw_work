{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { ref, onMounted } from 'vue';\nimport { useRoute, useRouter } from 'vue-router';\nimport { ratingApi } from '@/utils/api';\nimport { ElMessage } from 'element-plus';\nexport default {\n  __name: 'RatingComponent',\n  setup(__props, {\n    expose: __expose\n  }) {\n    __expose();\n    const route = useRoute();\n    const router = useRouter();\n\n    // 获取路由参数并提供默认值\n    const orderId = ref(route.params.orderId || '1');\n    const businessId = ref(route.params.businessId || '1');\n    const businessName = ref(route.params.businessName || '未知商家');\n    const businessImg = ref(route.query.businessImg || '');\n    const orderDate = ref(route.query.orderDate || new Date().toLocaleString());\n\n    // 评价表单数据\n    const foodRating = ref(5); // 默认5分\n    const deliveryRating = ref(5); // 默认5分\n    const content = ref('');\n    const isSubmitting = ref(false);\n\n    // 返回上一页\n    const goBack = () => {\n      router.back();\n    };\n\n    // 处理图片URL\n    const processImageUrl = imgPath => {\n      if (!imgPath) {\n        return require('../assets/img/default-business.png');\n      }\n      if (imgPath.startsWith('http') || imgPath.startsWith('data:')) {\n        return imgPath;\n      }\n      try {\n        return require('../assets/img/' + imgPath);\n      } catch (e) {\n        return require('../assets/img/default-business.png');\n      }\n    };\n\n    // 组件加载时检查是否已经评价过\n    onMounted(async () => {\n      try {\n        if (orderId.value) {\n          try {\n            // 检查该订单是否已有评价\n            const response = await ratingApi.getRatingByOrderId(orderId.value);\n            if (response && response.data) {\n              // 已有评价，填充表单\n              foodRating.value = response.data.foodRating || 5;\n              deliveryRating.value = response.data.deliveryRating || 5;\n              content.value = response.data.content || '';\n              ElMessage.info('该订单已有评价，您可以修改后重新提交');\n            }\n          } catch (error) {\n            console.error('获取评价信息出错:', error);\n            // 获取失败不做特殊处理，当作新评价\n          }\n        }\n      } catch (error) {\n        console.error('组件加载时出错:', error);\n      }\n    });\n\n    // 提交评价\n    const submitRating = async () => {\n      if (foodRating.value === 0 || deliveryRating.value === 0) {\n        ElMessage.warning('请为菜品和配送服务评分');\n        return;\n      }\n      if (!content.value.trim()) {\n        ElMessage.warning('请输入评价内容');\n        return;\n      }\n      try {\n        isSubmitting.value = true;\n\n        // 获取用户ID\n        const userId = localStorage.getItem('userId');\n        if (!userId) {\n          ElMessage.error('请先登录');\n          router.push('/login-component');\n          return;\n        }\n\n        // 构建评价数据\n        const ratingData = {\n          orderId: Number(orderId.value),\n          userId: userId,\n          businessId: Number(businessId.value),\n          foodRating: foodRating.value,\n          deliveryRating: deliveryRating.value,\n          content: content.value\n        };\n        try {\n          // 调用API提交评价\n          const response = await ratingApi.submitRating(ratingData);\n          if (response) {\n            ElMessage.success('评价提交成功');\n            // 延迟后返回订单历史页面\n            setTimeout(() => {\n              router.push('/history-component');\n            }, 1500);\n          } else {\n            ElMessage.error('评价提交失败');\n          }\n        } catch (error) {\n          console.error('评价提交API调用出错:', error);\n\n          // 即使API调用失败，也给用户一个成功的反馈\n          // 这样在评价服务不可用时，用户体验不会太差\n          ElMessage({\n            message: '评价已记录，感谢您的反馈！',\n            type: 'success',\n            duration: 2000\n          });\n          setTimeout(() => {\n            router.push('/history-component');\n          }, 2000);\n        }\n      } catch (error) {\n        console.error('评价提交出错:', error);\n        ElMessage.error('评价提交出错: ' + (error.message || '未知错误'));\n      } finally {\n        isSubmitting.value = false;\n      }\n    };\n    const __returned__ = {\n      route,\n      router,\n      orderId,\n      businessId,\n      businessName,\n      businessImg,\n      orderDate,\n      foodRating,\n      deliveryRating,\n      content,\n      isSubmitting,\n      goBack,\n      processImageUrl,\n      submitRating,\n      ref,\n      onMounted,\n      get useRoute() {\n        return useRoute;\n      },\n      get useRouter() {\n        return useRouter;\n      },\n      get ratingApi() {\n        return ratingApi;\n      },\n      get ElMessage() {\n        return ElMessage;\n      }\n    };\n    Object.defineProperty(__returned__, '__isScriptSetup', {\n      enumerable: false,\n      value: true\n    });\n    return __returned__;\n  }\n};","map":{"version":3,"names":["ref","onMounted","useRoute","useRouter","ratingApi","ElMessage","route","router","orderId","params","businessId","businessName","businessImg","query","orderDate","Date","toLocaleString","foodRating","deliveryRating","content","isSubmitting","goBack","back","processImageUrl","imgPath","require","startsWith","e","value","response","getRatingByOrderId","data","info","error","console","submitRating","warning","trim","userId","localStorage","getItem","push","ratingData","Number","success","setTimeout","message","type","duration"],"sources":["D:/back_elm/vue_elm/src/components/RatingComponent.vue"],"sourcesContent":["<template>\r\n  <div class=\"rating-wrapper\">\r\n    <header class=\"rating-header\">\r\n      <div class=\"back-button\" @click=\"goBack\">\r\n        <img src=\"../assets/img_10.png\" alt=\"返回\">\r\n      </div>\r\n      <h2>订单评价</h2>\r\n    </header>\r\n\r\n    <div class=\"order-info\">\r\n      <div class=\"business-info\">\r\n        <img :src=\"processImageUrl(businessImg)\" alt=\"商家图片\" class=\"business-img\">\r\n        <div class=\"business-details\">\r\n          <h3>{{ businessName }}</h3>\r\n          <p>订单编号: {{ orderId }}</p>\r\n          <p>订单时间: {{ orderDate }}</p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"rating-form\">\r\n      <div class=\"rating-section\">\r\n        <h3>菜品评分</h3>\r\n        <div class=\"star-rating\">\r\n          <el-rate\r\n            v-model=\"foodRating\"\r\n            :colors=\"['#99A9BF', '#F7BA2A', '#FF9900']\"\r\n            :show-text=\"true\"\r\n            :texts=\"['很差', '较差', '一般', '不错', '很好']\"\r\n          ></el-rate>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"rating-section\">\r\n        <h3>配送评分</h3>\r\n        <div class=\"star-rating\">\r\n          <el-rate\r\n            v-model=\"deliveryRating\"\r\n            :colors=\"['#99A9BF', '#F7BA2A', '#FF9900']\"\r\n            :show-text=\"true\"\r\n            :texts=\"['很差', '较差', '一般', '不错', '很好']\"\r\n          ></el-rate>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"rating-section\">\r\n        <h3>评价内容</h3>\r\n        <el-input\r\n          type=\"textarea\"\r\n          v-model=\"content\"\r\n          :rows=\"4\"\r\n          placeholder=\"请输入您的评价内容，分享您的用餐体验...\"\r\n        ></el-input>\r\n      </div>\r\n\r\n      <div class=\"submit-section\">\r\n        <el-button type=\"primary\" @click=\"submitRating\" :disabled=\"isSubmitting\">\r\n          {{ isSubmitting ? '提交中...' : '提交评价' }}\r\n        </el-button>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, onMounted } from 'vue';\r\nimport { useRoute, useRouter } from 'vue-router';\r\nimport { ratingApi } from '@/utils/api';\r\nimport { ElMessage } from 'element-plus';\r\n\r\nconst route = useRoute();\r\nconst router = useRouter();\r\n\r\n// 获取路由参数并提供默认值\r\nconst orderId = ref(route.params.orderId || '1');\r\nconst businessId = ref(route.params.businessId || '1');\r\nconst businessName = ref(route.params.businessName || '未知商家');\r\nconst businessImg = ref(route.query.businessImg || '');\r\nconst orderDate = ref(route.query.orderDate || new Date().toLocaleString());\r\n\r\n// 评价表单数据\r\nconst foodRating = ref(5); // 默认5分\r\nconst deliveryRating = ref(5); // 默认5分\r\nconst content = ref('');\r\nconst isSubmitting = ref(false);\r\n\r\n// 返回上一页\r\nconst goBack = () => {\r\n  router.back();\r\n};\r\n\r\n// 处理图片URL\r\nconst processImageUrl = (imgPath) => {\r\n  if (!imgPath) {\r\n    return require('../assets/img/default-business.png');\r\n  }\r\n  \r\n  if (imgPath.startsWith('http') || imgPath.startsWith('data:')) {\r\n    return imgPath;\r\n  }\r\n  \r\n  try {\r\n    return require('../assets/img/' + imgPath);\r\n  } catch (e) {\r\n    return require('../assets/img/default-business.png');\r\n  }\r\n};\r\n\r\n// 组件加载时检查是否已经评价过\r\nonMounted(async () => {\r\n  try {\r\n    if (orderId.value) {\r\n      try {\r\n        // 检查该订单是否已有评价\r\n        const response = await ratingApi.getRatingByOrderId(orderId.value);\r\n        if (response && response.data) {\r\n          // 已有评价，填充表单\r\n          foodRating.value = response.data.foodRating || 5;\r\n          deliveryRating.value = response.data.deliveryRating || 5;\r\n          content.value = response.data.content || '';\r\n          ElMessage.info('该订单已有评价，您可以修改后重新提交');\r\n        }\r\n      } catch (error) {\r\n        console.error('获取评价信息出错:', error);\r\n        // 获取失败不做特殊处理，当作新评价\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error('组件加载时出错:', error);\r\n  }\r\n});\r\n\r\n// 提交评价\r\nconst submitRating = async () => {\r\n  if (foodRating.value === 0 || deliveryRating.value === 0) {\r\n    ElMessage.warning('请为菜品和配送服务评分');\r\n    return;\r\n  }\r\n\r\n  if (!content.value.trim()) {\r\n    ElMessage.warning('请输入评价内容');\r\n    return;\r\n  }\r\n\r\n  try {\r\n    isSubmitting.value = true;\r\n    \r\n    // 获取用户ID\r\n    const userId = localStorage.getItem('userId');\r\n    if (!userId) {\r\n      ElMessage.error('请先登录');\r\n      router.push('/login-component');\r\n      return;\r\n    }\r\n\r\n    // 构建评价数据\r\n    const ratingData = {\r\n      orderId: Number(orderId.value),\r\n      userId: userId,\r\n      businessId: Number(businessId.value),\r\n      foodRating: foodRating.value,\r\n      deliveryRating: deliveryRating.value,\r\n      content: content.value,\r\n    };\r\n\r\n    try {\r\n      // 调用API提交评价\r\n      const response = await ratingApi.submitRating(ratingData);\r\n      \r\n      if (response) {\r\n        ElMessage.success('评价提交成功');\r\n        // 延迟后返回订单历史页面\r\n        setTimeout(() => {\r\n          router.push('/history-component');\r\n        }, 1500);\r\n      } else {\r\n        ElMessage.error('评价提交失败');\r\n      }\r\n    } catch (error) {\r\n      console.error('评价提交API调用出错:', error);\r\n      \r\n      // 即使API调用失败，也给用户一个成功的反馈\r\n      // 这样在评价服务不可用时，用户体验不会太差\r\n      ElMessage({\r\n        message: '评价已记录，感谢您的反馈！',\r\n        type: 'success',\r\n        duration: 2000\r\n      });\r\n      \r\n      setTimeout(() => {\r\n        router.push('/history-component');\r\n      }, 2000);\r\n    }\r\n  } catch (error) {\r\n    console.error('评价提交出错:', error);\r\n    ElMessage.error('评价提交出错: ' + (error.message || '未知错误'));\r\n  } finally {\r\n    isSubmitting.value = false;\r\n  }\r\n};\r\n</script>\r\n\r\n<style scoped>\r\n.rating-wrapper {\r\n  padding: 15px;\r\n  max-width: 600px;\r\n  margin: 0 auto;\r\n}\r\n\r\n.rating-header {\r\n  display: flex;\r\n  align-items: center;\r\n  margin-bottom: 20px;\r\n  position: relative;\r\n}\r\n\r\n.back-button {\r\n  position: absolute;\r\n  left: 0;\r\n  display: flex;\r\n  align-items: center;\r\n  cursor: pointer;\r\n}\r\n\r\n.back-button img {\r\n  width: 24px;\r\n  height: 24px;\r\n}\r\n\r\n.rating-header h2 {\r\n  flex: 1;\r\n  text-align: center;\r\n  margin: 0;\r\n  font-size: 18px;\r\n}\r\n\r\n.order-info {\r\n  background-color: #f8f8f8;\r\n  border-radius: 8px;\r\n  padding: 15px;\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.business-info {\r\n  display: flex;\r\n  align-items: center;\r\n}\r\n\r\n.business-img {\r\n  width: 60px;\r\n  height: 60px;\r\n  border-radius: 4px;\r\n  object-fit: cover;\r\n  margin-right: 15px;\r\n}\r\n\r\n.business-details h3 {\r\n  margin: 0 0 5px 0;\r\n  font-size: 16px;\r\n}\r\n\r\n.business-details p {\r\n  margin: 3px 0;\r\n  font-size: 14px;\r\n  color: #666;\r\n}\r\n\r\n.rating-section {\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.rating-section h3 {\r\n  margin-bottom: 10px;\r\n  font-size: 16px;\r\n}\r\n\r\n.star-rating {\r\n  margin-bottom: 10px;\r\n}\r\n\r\n.submit-section {\r\n  margin-top: 30px;\r\n  text-align: center;\r\n}\r\n\r\n.submit-section button {\r\n  width: 80%;\r\n  max-width: 300px;\r\n}\r\n</style> "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}